<!DOCTYPE html>
<html lang="ru">
<head>
<title>Chat Example</title>
<script type="text/javascript">
window.onload = function () {
    var conn;
    var msg = document.getElementById("msg");
    var log = document.getElementById("log");

    var left = false;
    var right = false;
    var up = false;
    var down = false;

    var x = 0;
    var y = 0;

    var id = '';

    var players = [];
    var zombies = [];
    var weapons = [];
    var updates = [];

    document.addEventListener("keydown", (event) => {
        if ( event.keyCode === 65) {
            if (!left) {
                left = true
                send();
            }
        }
        if (event.isComposing || event.keyCode === 68) {
            if (!right) {
                right = true
                send();
            }
        }
        if (event.isComposing || event.keyCode === 87) {
            if (!up) {
                up = true
                send();
            }
            
        }
        if (event.isComposing || event.keyCode === 83) {
            if (!down) {
                down = true
                send();
            }
        }
    });

    document.addEventListener("keyup", (event) => {
        if (event.isComposing || event.keyCode === 65) {
            left = false
            send();
        }
        if (event.isComposing || event.keyCode === 68) {
            right = false
            send();
        }
        if (event.isComposing || event.keyCode === 87) {
            up = false
            send();
        }
        if (event.isComposing || event.keyCode === 83) {
            down = false
            send();
        }
    });


    if (window["WebSocket"]) {
        conn = new WebSocket("ws://" + document.location.host + "/ws");
        conn.onclose = function (evt) {
            //appendLog('Connection closed');
        };
        conn.onmessage = function (evt) {
            
            var msg = evt.data;
            if (id == '') {
                properties = evt.data.split(':');
                if (properties[0] == 'id') {
                    id = properties[1];
                }
                return;
            }
            
            objects = msg.split('&');
            for (index in objects) {
                
                let object = objects[index]
                if (object == '') {
                    continue;
                }

                properties = object.split(':');
                if (properties[0] == 'c') {
                    player_id = properties[1]
                    player_y = properties[2]
                    player_x = properties[3]
                    if (players[player_id] == undefined) {
                        players[player_id] = {
                        x: player_x,
                        y: player_y
                    }
                    }
                    players[player_id]['to_x'] = player_x
                    players[player_id]['to_y'] = player_y
                }
                if (properties[0] == 'z') {
                    zobmie_id = properties[1]
                    zobmie_y = properties[2]
                    zobmie_x = properties[3]
                    zombies[zobmie_id] = {
                        x: zobmie_x,
                        y: zobmie_y,
                        isDeleted: false
                    }
                }
                if (properties[0] == 'd') {
                    player_id = properties[1]
                    delete players[player_id]
                }

                if (properties[0] == 'r') {
                    zombie_id = properties[1]
                    if (zombies[zombie_id] != undefined) {
                        zombies[zombie_id].isDeleted = true
                    }
                    
                }

                if (properties[0] == 'w') {
                    if (properties[1] == 1) {
                        weapons.push({
                            'type' : 1,
                            'player' : properties[2],
                            'to': properties[3], 
                            'frame': 0
                        })
                    }
                }

                if (properties[0] == 'u') {
                    if (properties[1] == id) {
                        updates.push([properties[2], properties[3], properties[4], properties[5]])
                        showUpdates()
                    }
                }

            
            }
        };
    }

    function showUpdates() {
        if (updates.length) {
            let element = document.getElementById("updates_container");
            element.classList.add("show");
            for (let i = 1; i < 4; i++) {
                let element1 = document.getElementById("update_" + i);
                element1.innerHTML = 'weapon: 1 update:' + updates[0][i]
            }
            
        }
    }


    function sendUpdate1() {
        let item = updates.shift();
        sendUpdate(item[0], item[1]);
    }
    function sendUpdate2() {
        let item = updates.shift();
        sendUpdate(item[0], item[2]);
    }
    function sendUpdate3() {
        let item = updates.shift();
        sendUpdate(item[0], item[3]);
    }

    function sendUpdate(weapon, update) {
        var bytes = Array(3);
        bytes[0] = 0x1; // send update
        bytes[1] = weapon;
        bytes[2] = update;
        var length = bytes.length;
        for (var i = 0; i < length; i++) {
            binaryString += String.fromCharCode(bytes[i]);
        }
        conn.send(binaryString);
        let element = document.getElementById("updates_container");
        element.classList.remove("show");
        
        if (updates.length) {
            showUpdates()
        }
    }

    function send() {
        binaryString = '';
        var bytes = Array(5);
        bytes[0] = 0x0; // send move
        if (left) {
            bytes[1] = 0x1;
        } else {
            bytes[1] = 0x0;
        }
        if (right) {
            bytes[2] = 0x1;
        } else {
            bytes[2] = 0x0;
        }
        if (up) {
            bytes[3] = 0x1;
        } else {
            bytes[3] = 0x0;
        }
        if (down) {
            bytes[4] = 0x1;
        } else {
            bytes[4] = 0x0;
        }
        var length = bytes.length;
        for (var i = 0; i < length; i++) {
            binaryString += String.fromCharCode(bytes[i]);
        }
        conn.send(binaryString);
    }
    


    var canvas = document.getElementById("canvas");
    var ctx = this.canvas.getContext("2d");

    function draw() {

        ctx.fillStyle = "white";
        ctx.fillRect(0,0, 1500, 800);

        for (player_id in players) {
            player = players[player_id]
            if (player_id == id) {
                ctx.fillStyle = "blue";
            } else {
                ctx.fillStyle = "green";
            }

            let x = (player.to_x - player.x) / 4
            player.x = (player.x*1) + (x*1)
            let y = (player.to_y - player.y) / 4
            player.y = (player.y*1) + (y*1)

            ctx.beginPath();
            ctx.arc(player.x, player.y, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        for (zombie_id in zombies) {
            zombie = zombies[zombie_id]
            ctx.fillStyle = "red";
            ctx.beginPath();
            ctx.arc(zombie.x, zombie.y, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        for (weapon_id in weapons) {
            weapon = weapons[weapon_id]
            player = players[weapon.player]
            zombie = zombies[weapon.to]
            if (zombies[weapon.to] != undefined) {
                ctx.beginPath();
                ctx.moveTo(player.x, player.y); 
                ctx.lineTo(zombie.x, zombie.y);
                ctx.stroke()
            }

            weapons[weapon_id].frame++
            if (weapons[weapon_id].frame > 1) {
                weapons.splice(weapon_id, 1);
            }
        }
        
        for (zombie_id in zombies) {
            zombie = zombies[zombie_id]
            if (zombie.isDeleted) {
                delete zombies[zombie_id]
            }
        }

        setTimeout(draw, 1000 / 60);
    }

    draw();
};
</script>

</head>
<body>
    <div class="canvas_container">
        <canvas id="canvas" width="2000" height="800"></canvas>
    </div>


    <div id="updates_container" class="un_show">
        <div class="update_item" id="update_1" onclick="sendUpdate1">test</div>
        <div class="update_item" id="update_2" onclick="sendUpdate2">test</div>
        <div class="update_item" id="update_3" onclick="sendUpdate3">test</div>
    </div>

    <style type="text/css">
        html {
            overflow: hidden;
        }
        
        body {
            overflow: hidden;
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            background: gray;
            display:flex;
        }

        .canvas_container {
            width: 100%;
            height: 100%;
        }

        #updates_container {
            position: absolute;
            bottom: 0;
            left: 50%;
        }

        .update_item {
            padding: 20px;
            margin: 10px;
            border-radius: 5px;
            background: #fff;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            border: 1px solid #ddd;
        }

        .un_show {
            display: none;
        }

        .show {
            display: flex;
        }
        
        </style>

</body>
</html>
